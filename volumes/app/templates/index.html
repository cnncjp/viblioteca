<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="container">
    <div class="row">Viblioteca - 学会ウェビナー検索</div>
    <div class="row">
        <input id="searchInput" class="form-control" placeholder="検索キーワードを入力してください(例: 人工知能)" onkeydown="keyDown(this);">
    </div>
    <br/>
    <div id="resultTitle" class="row"></div>
    <div id="result" class="row" style="overflow: auto; min-height: 200px; max-height: 370px; display: flex; border: 1px solid silver; border-radius: 4px;">
        <br/>
        <font color="gray">検索結果がここに表示されます。</font>
<!--
        <div class="btn btn-light" data-bs-toggle="button" aria-pressed="false" style="width:180px; height:180px; display: flexbox; border: 1px solid silver; border-radius: 4px;">
            <b><small>[<span>CNNC</span>]</small></b><br/>
            <span>サンプル</span>
        </div>
-->
    </div>
    <br/>
    <div id="pageTitle" class="row"></div>
    <div id="page" class="row" style="min-height: 400px; border: 1px solid silver; border-radius: 4px;">
        <br/>
        <font color="gray">クリックしたページがここに表示されます。</font>

<!--
        <iframe width="640" height="360" src="https://webinar.ieice.org/summary.php?id=177&expandable=1&code=PRS&sel=&year=2020"></iframe>
        <iframe allow="autoplay; fullscreen" allowfullscreen="" frameborder="0" height="360" src="https://player.vimeo.com/video/487952537" width="640"></iframe>
-->
    </div>
    <template id="sr">
        <div class="btn btn-light" data-toggle="button" style="position: relative; overflow: hidden; width:240px; height:240px; display: flexbox; border: 1px solid silver; border-radius: 4px;">
            <small>[<span></span>]</small><br/>
            <small><span></span></small>
            <img src="" width="220px" height="100px" style="padding: 2px; margin: 0px; object-fit: contain; left: -8px;">
            <font color="dimgray"><span></span></font>
        </div>
    </template>
    <template id="resultPage">
        <iframe width="640" height="720" src=""></iframe>
    </template>
    <hr>
    Copyright <a href="https://cnnc.jp/">Connections Co., Ltd.</a>
</div>
<script>
let timer = null;
const videos = new Map();
let lastKeyDownMillis = new Date().getTime();
function keyDown(self){
    lastKeyDownMillis = new Date().getTime();
    if(timer != null) return;
    timer = setTimeout(doSearch, 1000);
    console.log("timer start");
}
function doSearch(){
    const d = new Date().getTime() - lastKeyDownMillis;
    if(d >= 1000){
        const query = $("#searchInput").val().trim();
        console.log("do search");
        $.getJSON('search', {query: query}, result=>{
            const template = document.querySelector('#sr');
            const resDiv = $("#result");
            resDiv.empty();
            $("#page").empty();
            videos.clear();
            const resultTitle = (query != "") ?
                `検索結果: ${result.length}件(キーワード: ${query})` :
                `全ての動画: ${result.length}件`;
            $("#resultTitle").empty().append($("<span>").text(resultTitle));
            $("#pageTitle").empty().append($("<span>").text("クリックしたページがここに表示されます。"));
            for(const r of result){
                const div = $(template.content.cloneNode(true));
                const org = r["org"];
                const title = r["title"];
                const description = r["description"];
                let shortTitle = title;
                if(shortTitle.length > 26){
                    shortTitle = shortTitle.substring(0, 25) + "…";
                }
                const indexText = r["indexText"];
                const idx = indexText.toLowerCase().indexOf(query.toLowerCase());
                let kwic = $("<span>");
                const total = 25;
                if(query.length > 0 && idx != -1){
                    const rest = total - query.length;
                    const prefixBegin = idx - (rest / 2);
                    const prefix = indexText.substring(prefixBegin, idx).trim();
                    kwic.append((prefixBegin == 0 ? "": "…") + prefix)
                        .append($("<b>").append($("<font>").attr("color", "#556666").text(indexText.substring(idx, idx + query.length))))
                        .append(indexText.substring(idx + query.length, idx + query.length + (rest - prefix.length)).trim() + "…");
                } else{
                    kwic = (description.length <= total) ? description : description.substring(0, total) + "…";
                }
                div.find("span:eq(0)").text(r["org"]);
                div.find("span:eq(1)").text(`${r["id"]}. ${shortTitle}`);
                div.find("span:eq(2)").append(kwic);
                const thumb = r["thumbUrl"] == "nothumb.png" ? "/static/img/nothumb.png" : r["thumbUrl"]
                div.find("img").attr("src", thumb);
                resDiv.append(div);
                const id = r["id"];
                videos.set(id, {
                    "type": r["type"],
                    "url": r["url"],
                    "thumbUrl": r["thumbUrl"]});
                resDiv.find("div:last").on("click", ()=>{
                    const v = videos.get(id);
                    const pageContainer = $("#page");
                    const pageNode = $(document.querySelector('#resultPage').content.cloneNode(true));
                    pageNode.find("iframe").attr("src", v["url"]);
                    pageContainer.empty().append(pageNode);
                    $("#pageTitle").empty().append($("<span>").text(`表示中のページ: [${org}] ${title}`));
                });
            }
        }).fail(function(XMLHttpRequest, textStatus, errorThrown){
            alert(errorThrown);
        });
        timer = null;
    } else{
        console.log("timer restart " + (1000 - d));
        timer = setTimeout(doSearch, 1000 - d);
    }
}
$(doSearch);
</script>
</body>
</html>
