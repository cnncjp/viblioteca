<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    </head>
<body>
<div class="container">
    <div class="row">Viblioteca - 学会ウェビナー検索</div>
    <div class="row">
        <input id="searchInput" class="form-control" placeholder="検索キーワードを入力してください(例: 人工知能)" onkeydown="keyDown(this);">
    </div>
    <div class="row">
        <div class="col">並び替え:
            <input id="noOrder" type="radio" name="sort" class="form-check-input" style="display: inline-block;" value="none" checked>
            <label for="noOrder" class="form-check-label">新着順</label>
            &nbsp;
            <input id="orderByViewCount" type="radio" name="sort" class="form-check-input" style="display: inline-block;" value="viewCount">
            <label for="orderByViewCount" class="form-check-label">再生回数</label>
            &nbsp;
            <input id="orderByLikeCount" type="radio" name="sort" class="form-check-input" style="display: inline-block;" value="likeCount">
            <label for="orderByLikeCount" class="form-check-label">いいね回数</label>
        </div>
    </div>
    <br/>
    <div id="resultTitle" class="row"></div>
    <div id="result" class="row" style="overflow: auto; min-height: 200px; max-height: 370px; display: flex; border: 1px solid silver; border-radius: 4px;">
        <br/>
        <font color="gray">検索結果がここに表示されます。</font>
<!--
        <div class="btn btn-light" data-bs-toggle="button" aria-pressed="false" style="width:180px; height:180px; display: flexbox; border: 1px solid silver; border-radius: 4px;">
            <b><small>[<span>CNNC</span>]</small></b><br/>
            <span>サンプル</span>
        </div>
-->
    </div>
    <br/>
    <div id="pageTitle" class="row"></div>
    <div id="page" class="row" style="min-height: 400px; border: 1px solid silver; border-radius: 4px;">
        <br/>
        <font color="gray">クリックしたページがここに表示されます。</font>
<!--
        <iframe width="640" height="360" src="https://webinar.ieice.org/summary.php?id=177&expandable=1&code=PRS&sel=&year=2020"></iframe>
        <iframe allow="autoplay; fullscreen" allowfullscreen="" frameborder="0" height="360" src="https://player.vimeo.com/video/487952537" width="640"></iframe>
-->
    </div>
    <template id="sr">
        <div class="btn btn-light" data-toggle="button" style="position: relative; overflow: hidden; width:312px; height:312px; display: flexbox; border: 1px solid silver; border-radius: 4px;">
            <small>[<span title="組織名"></span>]</small>
            <span class="material-icons-outlined" style="font-size: 1rem; vertical-align: text-bottom;" title="再生回数">preview</span>
            <span style="font-size: 1rem" title="再生回数"></span>
            <span class="material-icons-outlined" style="font-size: 1rem; vertical-align: text-bottom;" title="いいね回数">thumb_up</span>
            <span style="font-size: 1rem" title="いいね回数"></span>
            <br/>
            <small><span title="タイトル"></span></small><br/>
            <img title="サムネイル" src="" width="220px" height="100px" style="padding: 2px; margin: 0px; object-fit: contain; left: -8px;"><br/>
            <small><font color="dimgray"><span title="説明"></span></font><br/></small>
            <small><span title="公開日"></span></small>
        </div>
    </template>
    <template id="resultPage">
        <iframe width="640" height="720" src=""></iframe>
    </template>
    <template id="resultPageNotEmbeddable">
        <div>
            <h4>コンテンツのポリシーにより表示できません。<br/>下記のリンクをクリックすると，別ウィンドウでウェビナーページが表示されます。</h4>
            <big><a href="https://webinar.ieice.org/summary.php?id=177&expandable=1&code=PRS&sel=&year=2020" target="_blank">動画ページを開く</a></big>
        </div>
    </template>
    <hr>
    Copyright <a href="https://cnnc.jp/">Connections Co., Ltd.</a>
</div>
<script>
let timer = null;
const videos = new Map();
let lastKeyDownMillis = new Date().getTime();
function keyDown(self){
    lastKeyDownMillis = new Date().getTime();
    if(timer != null) return;
    timer = setTimeout(doSearch, 1000);
    console.log("timer start");
}
function doSearch(){
    const d = new Date().getTime() - lastKeyDownMillis;
    if(d >= 1000){
        const query = $("#searchInput").val().trim();
        const sort = document.querySelector("input[type='radio'][name='sort']:checked").getAttribute("value");
        console.log(`do search('${query}', ${sort})`);
        $.getJSON('search', {query: query, sort: sort}, result=>{
            const template = document.querySelector('#sr');
            const resDiv = $("#result");
            resDiv.empty();
            $("#page").empty();
            videos.clear();
            const resultTitle = (query != "") ?
                `検索結果: ${result.length}件(検索ワード: ${query})` :
                `全ての動画: ${result.length}件`;
            $("#resultTitle").empty().append($("<span>").text(resultTitle));
            $("#pageTitle").empty().append($("<span>").text("クリックしたページがここに表示されます。"));
            for(const r of result){
                const div = $(template.content.cloneNode(true));
                const org = r["org"];
                const title = r["title"];
                const description = r["description"];
                const publishedAt = r["publishedAt"];
                const orgLength = 12;
                let shortOrg = org;
                if(shortOrg.length > orgLength){
                    shortOrg = shortOrg.substring(0, orgLength - 1) + "…";
                }
                const titleLength = 40;
                let shortTitle = title;
                if(shortTitle.length > titleLength){
                    shortTitle = shortTitle.substring(0, titleLength - 1) + "…";
                }
                const indexText = r["indexText"];
                const idx = indexText.toLowerCase().indexOf(query.toLowerCase());
                let kwic = $("<span>");
                const total = 68;
                if(query.length > 0 && idx != -1){
                    const rest = total - query.length;
                    const prefixBegin = idx - (rest / 2);
                    const prefix = indexText.substring(prefixBegin, idx).trim();
                    kwic.append((prefixBegin == 0 ? "": "…") + prefix)
                        .append($("<b>").append($("<font>").attr("color", "#556666").text(indexText.substring(idx, idx + query.length))))
                        .append(indexText.substring(idx + query.length, idx + query.length + (rest - prefix.length)).trim() + "…");
                } else{
                    kwic = (description.length <= total) ? description : description.substring(0, total) + "…";
                }
                div.find("span:eq(0)").attr("title", org).text(shortOrg);
                if(r["type"] != "youtube"){
                    div.find("span:eq(1)").css("display", "none");
                    div.find("span:eq(2)").css("display", "none");
                    div.find("span:eq(3)").css("display", "none");
                    div.find("span:eq(4)").css("display", "none");
                } else{
                    div.find("span:eq(2)").text(r["viewCount"]);
                    div.find("span:eq(4)").text(r["likeCount"]);
                }
                div.find("span:eq(5)").attr("title", title).text(`${shortTitle}`);
                div.find("span:eq(7)").append(publishedAt + "公開"); // kwicでspanが追加されるので，それより前に日付を追加する
                div.find("span:eq(6)").attr("title", description).append(kwic);
                const thumb = r["thumbUrl"] == "nothumb.png" ? "/static/img/nothumb.png" : r["thumbUrl"].replace("http:", "https:");
                div.find("img").attr("src", thumb);
                resDiv.append(div);
                const id = r["id"];
                const embeddable = r["embeddable"];
                videos.set(id, {
                    "type": r["type"],
                    "url": r["url"],
                    "embeddable": r["embeddable"],
                    "thumbUrl": r["thumbUrl"]});
                resDiv.find("div:last").on("click", ()=>{
                    let pageNode = null;
                    const v = videos.get(id);
                    if(v["embeddable"]){
                        pageNode = $(document.querySelector('#resultPage').content.cloneNode(true));
                        pageNode.find("iframe").attr("src", v["url"]);
                    } else{
                        pageNode = $(document.querySelector("#resultPageNotEmbeddable").content.cloneNode(true));
                        pageNode.find("a").attr("href", v["url"]);
                    }
                    const pageContainer = $("#page");
                    pageContainer.empty().append(pageNode);
                    $("#pageTitle").empty().append($("<span>").text(`表示中のページ: [${org}] ${title}`));
                });
            }
        }).fail(function(XMLHttpRequest, textStatus, errorThrown){
            alert(errorThrown);
        });
        timer = null;
    } else{
        console.log("timer restart " + (1000 - d));
        timer = setTimeout(doSearch, 1000 - d);
    }
}
window.addEventListener("load", ()=>{
    doSearch();
    document.querySelectorAll("input[type='radio'][name='sort']").forEach(elm=>{
        elm.addEventListener("click", e=>{
            doSearch();
        });
    });
});
</script>
</body>
</html>
