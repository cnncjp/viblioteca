<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="container">
    <div class="row">Webinar検索</div>
    <div class="row">
        <input id="searchInput" class="form-control" placeholder="検索キーワードを入力してください(例: 人工知能)" onkeydown="keyDown(this);">
    </div>
    <br/>
    <div id="resultTitle" class="row"></div>
    <div id="result" class="row" style="overflow: auto; min-height: 200px; max-height: 370px; display: flex; border: 1px solid silver; border-radius: 4px;">
        <br/>
        <font color="gray">検索結果がここに表示されます。</font>
<!--        
        <div class="btn btn-light" data-bs-toggle="button" aria-pressed="false" style="width:180px; height:180px; display: flexbox; border: 1px solid silver; border-radius: 4px;">
            <b><small>[<span>CNNC</span>]</small></b><br/>
            <span>サンプル</span>
        </div>
-->
    </div>
    <br/>
    <div id="pageTitle" class="row"></div>
    <div id="page" class="row" style="min-height: 400px; border: 1px solid silver; border-radius: 4px;">
        <br/>
        <font color="gray">クリックしたページがここに表示されます。</font>

<!--
        <iframe width="640" height="360" src="https://webinar.ieice.org/summary.php?id=177&expandable=1&code=PRS&sel=&year=2020"></iframe>
        <iframe allow="autoplay; fullscreen" allowfullscreen="" frameborder="0" height="360" src="https://player.vimeo.com/video/487952537" width="640"></iframe>
-->
    </div>
    <template id="sr">
        <div class="btn btn-light" data-toggle="button" style="overflow: hidden; width:180px; height:180px; display: flexbox; border: 1px solid silver; border-radius: 4px;">
            <small>[<span></span>]</small><br/>
            <big><span></span></big><br/>
            <font color="gray"><span></span></font>
            <!-- img src="" width="180px" height="180px" -->
        </div>
    </template>
    <template id="resultPage">
        <iframe width="640" height="720" src=""></iframe>
    </template>
    <hr>
    Copyright <a href="https://cnnc.jp/">Connections Co., Ltd.</a>
</div>
<script>
let timer = null;
const urls = new Map();
let lastKeyDownMillis = new Date().getTime();
function keyDown(self){
    lastKeyDownMillis = new Date().getTime();
    if(timer != null) return;
    timer = setTimeout(doSearch, 1000);
    console.log("timer start");
}
function doSearch(){
    const d = new Date().getTime() - lastKeyDownMillis;
    if(d >= 1000){
        const query = $("#searchInput").val().trim();
        console.log("do search");
        $.getJSON('search', {query: query}, result=>{
            const template = document.querySelector('#sr');
            const resDiv = $("#result");
            resDiv.empty();
            $("#page").empty();
            urls.clear();
            $("#resultTitle").empty().append($("<span>").text(`検索結果: ${result.length}件(キーワード: ${query})`));
            for(const r of result){
                const div = $(template.content.cloneNode(true));
                const org = r["org"];
                const title = r["title"];
                let shortTitle = title;
                if(shortTitle.length > 26){
                    shortTitle = shortTitle.substring(0, 25) + "…";
                }
                const description = r["description"];
                const idx = description.indexOf(query);
                let kwic = $("<span>");
                if(query.length > 0 && idx != -1){
                    const psc = 10;
                    kwic.append("…" + description.substring(idx - psc, idx).trim())
                        .append($("<b>").append($("<font>").attr("color", "#556666").text(query)))
                        .append(description.substring(idx + query.length, idx + query.length + psc).trim() + "…");
                } else{
                    kwic = description.substring(0, 24) + "…";
                }
                div.find("span:eq(0)").text(r["org"]);
                div.find("span:eq(1)").text(shortTitle);
                div.find("span:eq(2)").append(kwic);
//                    div.find("img").attr("src", r[8]);
                resDiv.append(div);
                const id = r["id"];
                urls.set(id, r["url"]);
                resDiv.find("div:last").on("click", ()=>{
                    const url = urls.get(id);
                    console.log(`${id}: ${url}`);
                    const pageContainer = $("#page");
                    const pageNode = $(document.querySelector('#resultPage').content.cloneNode(true));
//                    pageContainer.empty();
                    pageNode.find("iframe").attr("src", url);
                    pageContainer.empty().append(pageNode);
                    $("#pageTitle").empty().append($("<span>").text(`表示中のページ: [${org}] ${title}`));
                });
            }
            console.log(result);
        }).fail(function(XMLHttpRequest, textStatus, errorThrown){
            alert(errorThrown);
        });
        timer = null;
    } else{
        console.log("timer restart " + (1000 - d));
        timer = setTimeout(doSearch, 1000 - d);
    }
}
</script>
</body>
</html>
